name: Deploy to SFTP

on:
  push:
    branches:
      - main  # vagy bármelyik branch, amit szeretnél deployolni
  workflow_dispatch:  # Manuális trigger lehetősége

env:
  FORCE_COLOR: 1
  NODE_VERSION: 22.13.1

jobs:
  build-and-deploy:
    name: Build and Deploy Ghost
    runs-on: ubuntu-latest
    environment: production
    timeout-minutes: 60

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: true

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'yarn'

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Build Ghost
        run: |
          yarn build
          # Explicitly build ghost core (TypeScript and Assets) as it has no 'build' script
          yarn workspace ghost run build:tsc
          yarn workspace ghost run build:assets

      - name: Create Release Package
        run: |
          cd ghost/core
          # npm pack will run prepack (monobundle.js) automatically
          # This bundles workspace dependencies and updates package.json
          npm pack

          # The file will be named ghost-x.y.z.tgz. Find it.
          TGZ_FILE=$(ls ghost-*.tgz)
          echo "Packed file: $TGZ_FILE"

          # Extract it to a temporary directory
          mkdir -p ../../ghost-deployment
          tar -xzf $TGZ_FILE -C ../../ghost-deployment --strip-components=1

          # Do NOT copy yarn.lock from root.
          # The package.json generated by npm pack contains 'file:components/...' references
          # which are incompatible with the root yarn.lock (which expects workspace links).
          # Letting yarn generate a fresh lockfile on the server ensures correct resolution.

          # Verify package.json in deployment has resolved workspace deps
          echo "Verifying @tryghost/i18n dependency in package.json:"
          grep "@tryghost/i18n" ../../ghost-deployment/package.json

      - name: Create deployment archive
        run: |
          cd ghost-deployment
          zip -r ../ghost-deployment.zip .
          cd ..
          echo "Archive size: $(du -h ghost-deployment.zip | cut -f1)"

      - name: Upload to SFTP
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SFTP_HOST }}
          username: ${{ secrets.SFTP_USERNAME }}
          password: ${{ secrets.SFTP_PASSWORD }}
          port: ${{ secrets.SFTP_PORT || 22 }}
          source: "ghost-deployment.zip"
          target: ${{ secrets.SFTP_REMOTE_PATH || '/tmp' }}

      - name: Execute Remote Update
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SFTP_HOST }}
          username: ${{ secrets.SFTP_USERNAME }}
          password: ${{ secrets.SFTP_PASSWORD }}
          port: ${{ secrets.SFTP_PORT || 22 }}
          script: |
            # Navigate to the deployment directory
            TARGET_DIR="${{ secrets.SFTP_REMOTE_PATH }}"
            if [ -z "$TARGET_DIR" ]; then
              echo "Error: SFTP_REMOTE_PATH secret is not set. Cannot determine deployment directory."
              exit 1
            fi

            cd "$TARGET_DIR"

            echo "Unzipping update..."
            unzip -o ghost-deployment.zip

            echo "Removing old lockfile..."
            rm -f yarn.lock

            echo "Installing dependencies..."
            # Using --ignore-engines to bypass Node 22 incompatibility with some packages
            yarn install --ignore-engines

            echo "Restarting Ghost..."
            # Ensure ghost command is found (add common paths)
            export PATH=$PATH:/usr/local/bin:/usr/bin:/bin
            ghost restart

